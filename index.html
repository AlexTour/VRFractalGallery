<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fractal Cosmos: a VR Gallery</title>
    <meta name="description" content="Fractal Cosmos: a VR Gallery">

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-layout-component@5.3.0/dist/aframe-layout-component.min.js"></script>
    <script src="https://unpkg.com/aframe-template-component@3.2.1/dist/aframe-template-component.min.js"></script>
    <script src="https://unpkg.com/aframe-proxy-event-component@2.1.0/dist/aframe-proxy-event-component.min.js"></script>

    <style>
      /* Fullscreen GIF loader */
      #loader {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: black url("output_prRz0G.gif") center center no-repeat;
        background-size: cover;
        z-index: 9999;
        opacity: 1;
        transition: opacity 1.2s ease; /* smooth fade */
      }
      #loader.fade-out {
        opacity: 0;
        pointer-events: none;
      }
    </style>

    <script>
      // Audio toggle system
      AFRAME.registerComponent('scene-audio', {
        init: function () {
          this.audio1 = document.querySelector('#audio1');
          this.audio2 = document.querySelector('#audio2');
          this.current = null;

          this.el.addEventListener('set-scene-audio', e => {
            let choice = e.detail.track;
            if (choice === 1) {
              this.playAudio(this.audio1);
            } else {
              this.playAudio(this.audio2);
            }
          });
        },
        playAudio: function (audioEl) {
          if (this.current && this.current !== audioEl) {
            this.current.pause();
            this.current.currentTime = 0;
          }
          this.current = audioEl;
          if (this.current.paused) {
            this.current.play();
          }
        }
      });

      // Map thumbnail click â†’ audio change
      AFRAME.registerComponent('link-audio', {
        schema: { track: { type: 'int', default: 1 } },
        init: function () {
          this.el.addEventListener('click', () => {
            let sceneEl = document.querySelector('a-scene');
            sceneEl.emit('set-scene-audio', { track: this.data.track });
          });
        }
      });

      // Hide loader when scene is ready with fade-out
      window.addEventListener('load', () => {
        let sceneEl = document.querySelector('a-scene');
        sceneEl.addEventListener('loaded', () => {
          let loader = document.getElementById('loader');
          loader.classList.add('fade-out');
          setTimeout(() => { loader.style.display = 'none'; }, 1501); // remove after fade
        });
      });
    </script>
  </head>
  <body>
    <!-- GIF Loader Overlay -->
    <div id="loader"></div>

    <a-scene scene-audio>
      <a-assets>
        <!-- 360 images -->
        <img id="architect" src="Assets/architect.jpg">
        <img id="architect2" src="Assets/architect2.jpg">
        <img id="citypurple" src="Assets/citypurple.jpg">

        <!-- Audio -->
        <audio id="audio1" src="NeoGreenChamber.wav" preload="auto" loop crossorigin="anonymous"></audio>
        <audio id="audio2" src="PristineAtrium.wav" preload="auto" loop crossorigin="anonymous"></audio>
      </a-assets>

      <!-- Default 360 -->
      <a-sky id="image-360" radius="10" src="#architect"></a-sky>

      <!-- Thumbnails with audio mapping -->
      <a-entity id="links" position="0 -1 -3">
        <a-entity template="src: #link" data-src="#architect" data-thumb="#thumb-architect"
                  position="-1.5 1 0" link-audio="track: 1"></a-entity>
        <a-entity template="src: #link" data-src="#architect2" data-thumb="#thumb-architect2"
                  position="0 1 0" link-audio="track: 2"></a-entity>
        <a-entity template="src: #link" data-src="#citypurple" data-thumb="#thumb-citypurple"
                  position="1.5 1 0" link-audio="track: 1"></a-entity>
      </a-entity>

      <!-- Camera -->
      <a-entity camera look-controls>
        <a-cursor id="cursor"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          event-set__mouseenter="_event: mouseenter; color: springgreen"
          event-set__mouseleave="_event: mouseleave; color: black"
          raycaster="objects: .link"></a-cursor>
      </a-entity>
    </a-scene>
  </body>
</html>
