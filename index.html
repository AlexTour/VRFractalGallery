<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Fractal Cosmos: a VR Gallery</title>
    <meta name="description" content="Fractal Cosmos: a VR Gallery">

    <meta property="og:url" content="https://alextour.github.io/VRFractalGallery/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Fractal Cosmos: a VR Gallery">
    <meta property="og:description" content="Explore Fractals like never before.">

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-layout-component@5.3.0/dist/aframe-layout-component.min.js"></script>
    <script src="https://unpkg.com/aframe-template-component@3.2.1/dist/aframe-template-component.min.js"></script>
    <script src="https://unpkg.com/aframe-proxy-event-component@2.1.0/dist/aframe-proxy-event-component.min.js"></script>

    <!-- keep your original template -->
    <script id="link" type="text/html">
      <a-entity class="link"
        geometry="primitive: plane; height: 0.5; width: 0.5"
        material="src: ${thumb}"
        transparent="true"
        opacity="0.9"
        alpha-test="0.5"

        event-set__mouseenter="scale: 1.2 1.2 1"
        event-set__mouseleave="scale: 1 1 1"
        event-set__click="_target: #image-360; _delay: 300; material.src: ${src}"
        proxy-event="event: click; to: #image-360; as: fade"
        sound="on: click; src: #click-sound"></a-entity>
    </script>

    <style>
      /* fullscreen GIF loader */
      #loader {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: black center center no-repeat;
        background-size: cover;
        z-index: 9999;
        opacity: 1;
        transition: opacity 1s ease;
        pointer-events: auto;
      }
      #loader.fade-out { opacity: 0; pointer-events: none; }

      /* headphones modal (appears after loader) */
      #headphone-modal {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 10001;
        background: rgba(0,0,0,0.92);
        color: #fff;
        padding: 18px 20px;
        border-radius: 8px;
        max-width: 92%;
        width: 420px;
        text-align: center;
        display: none;
        box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        font-family: sans-serif;
        transition: opacity 0.6s ease;
        opacity: 1;
      }
      #headphone-modal.fade { opacity: 0; pointer-events: none; }
      #headphone-modal img { max-width: 260px; display:block; margin: 0 auto 12px; }

      #headphone-modal h2 { margin: 6px 0; font-size: 1.15rem; }
      #headphone-modal p { margin: 8px 0 12px; color: #ddd; line-height: 1.3; }

      #headphone-modal button {
        background: #1db954;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 1rem;
        border-radius: 6px;
        cursor: pointer;
      }

      #audio-fallback {
        position: fixed;
        left: 50%;
        bottom: 20px;
        transform: translateX(-50%);
        z-index: 10002;
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        display: none;
        font-family: sans-serif;
      }
    </style>

    <!-- register scene-audio component BEFORE scene so attribute attaches cleanly -->
    <script>
      AFRAME.registerComponent('scene-audio', {
        init: function () {
          this.audio1 = document.querySelector('#audio1'); // EXACT name you used
          this.audio2 = document.querySelector('#audio2'); // EXACT name you used
        },
        playAll: function () {
          if (!this.audio1 || !this.audio2) return Promise.resolve();
          this.audio1.loop = true;
          this.audio2.loop = true;
          const p1 = this.audio1.play();
          const p2 = this.audio2.play();
          const wrap = (p) => (p && typeof p.then === 'function') ? p : Promise.resolve();
          return Promise.all([wrap(p1), wrap(p2)]);
        },
        pauseAll: function () {
          if (this.audio1) try { this.audio1.pause(); } catch(e){}
          if (this.audio2) try { this.audio2.pause(); } catch(e){}
        }
      });
    </script>
  </head>

  <body>
    <!-- loader shows while scene + assets load; background image uses your exact gif filename -->
    <div id="loader" style="background-image: url('Assets/output_prRz0G.gif');"></div>

    <!-- headphones modal (shows GIF + message after loader) -->
    <div id="headphone-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <!-- use your exact gif file here too so user definitely sees it -->
      <img src="Assets/output_prRz0G.gif" alt="intro animation" />
      <h2 id="modal-title">For the best experience, wear headphones</h2>
      <p>Fractal Cosmos uses layered sound. Tap to enter and start audio.</p>
      <div style="margin-top:8px;">
        <button id="next-btn">Tap to Enter Gallery</button>
      </div>
    </div>

    <div id="audio-fallback">Audio blocked â€” tap anywhere to enable sound.</div>

    <!-- keep your original a-scene + assets exactly -->
    <a-scene scene-audio loading-screen="backgroundColor: black;">
      <a-assets>
        <!-- include loader gif as asset (A-Frame waits for it) -->
        <img id="loader-gif" src="Assets/output_prRz0G.gif" crossorigin="anonymous">

        <!-- 360 images (unchanged) -->
        <img id="calabriabnw" crossorigin="anonymous" src="Assets/calabriabnw.jpg">
        <img id="architect" crossorigin="anonymous" src="Assets/architect.jpg">
        <img id="architect2" crossorigin="anonymous" src="Assets/architect2.jpg">
        <img id="citypurple" crossorigin="anonymous" src="Assets/citypurple.jpg">
        <img id="miraduro" crossorigin="anonymous" src="Assets/miraduro.jpg">
        <img id="aquarium" crossorigin="anonymous" src="Assets/aquarium360REDUCED.jpg">
        <img id="calabriaColor" crossorigin="anonymous" src="Assets/calabriaREDUCED.jpg">
        <img id="circus" crossorigin="anonymous" src="Assets/circusREDUCED.jpg">
        <img id="mindyourtrippy" crossorigin="anonymous" src="Assets/mindyourtrippy360REDUCED.jpg">
        <img id="pinkturqouise" crossorigin="anonymous" src="Assets/pinkturqouiseREDUCED.jpg">

        <!-- thumbs (unchanged) -->
        <img id="thumb-calabriabnw" crossorigin="anonymous" src="Assets/thumb-calabriabnw.png">
        <img id="thumb-architect" crossorigin="anonymous" src="Assets/thumb-architect.png">
        <img id="thumb-architect2" crossorigin="anonymous" src="Assets/thumb-architect2.png">
        <img id="thumb-citypurple" crossorigin="anonymous" src="Assets/thumb-citypurple.png">
        <img id="thumb-miraduro" crossorigin="anonymous" src="Assets/thumb-miraduro.png">
        <img id="thumb-aquarium" crossorigin="anonymous" src="Assets/thumb-aquarium.png">
        <img id="thumb-calabria" crossorigin="anonymous" src="Assets/thumb-calabria.png">
        <img id="thumb-circus" crossorigin="anonymous" src="Assets/thumb-circus.png">
        <img id="thumb-mindyourtrippy" crossorigin="anonymous" src="Assets/thumb-mindyourtrippy.png">
        <img id="thumb-pinkturqouise" crossorigin="anonymous" src="Assets/thumb-pinkturqouise.png">

        <img id="city-thumb" crossorigin="anonymous" src="Assets/infobox@2x.jpg">

        <!-- click sound (unchanged) -->
        <audio id="click-sound" crossorigin="anonymous"
               src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg" preload="auto"></audio>

        <!-- YOUR exact background audio names (unchanged) -->
        <audio id="audio1" src="Assets/NeoGreenChamber.wav" preload="auto" crossorigin="anonymous"></audio>
        <audio id="audio2" src="Assets/PristineAtrium.wav" preload="auto" crossorigin="anonymous"></audio>
      </a-assets>

      <!-- 360 sky -->
      <a-sky id="image-360" radius="10" src="#architect"
             animation__fade="property: components.material.material.color; type: color; from: #FFF; to: #000; dur: 300; startEvents: fade"
             animation__fadeback="property: components.material.material.color; type: color; from: #000; to: #FFF; dur: 300; startEvents: animationcomplete__fade"></a-sky>

      <!-- thumbnails (unchanged) -->
      <a-entity id="links" position="0 -1 -3">
        <a-entity template="src: #link" data-src="#architect" data-thumb="#thumb-architect" position="-1.5 1 0"></a-entity>
        <a-entity template="src: #link" data-src="#architect2" data-thumb="#thumb-architect2" position="-0.75 1 0"></a-entity>
        <a-entity template="src: #link" data-src="#citypurple" data-thumb="#thumb-citypurple" position="0 1 0"></a-entity>
        <a-entity template="src: #link" data-src="#calabriabnw" data-thumb="#thumb-calabriabnw" position="0.75 1 0"></a-entity>
        <a-entity template="src: #link" data-src="#miraduro" data-thumb="#thumb-miraduro" position="1.5 1 0"></a-entity>

        <a-entity template="src: #link" data-src="#aquarium" data-thumb="#thumb-aquarium" position="-1.5 0.25 0"></a-entity>
        <a-entity template="src: #link" data-src="#calabriaColor" data-thumb="#thumb-calabria" position="-0.75 0.25 0"></a-entity>
        <a-entity template="src: #link" data-src="#circus" data-thumb="#thumb-circus" position="0 0.25 0"></a-entity>
        <a-entity template="src: #link" data-src="#mindyourtrippy" data-thumb="#thumb-mindyourtrippy" position="0.75 0.25 0"></a-entity>
        <a-entity template="src: #link" data-src="#pinkturqouise" data-thumb="#thumb-pinkturqouise" position="1.5 0.25 0"></a-entity>
      </a-entity>

      <!-- Camera + cursor -->
      <a-entity camera look-controls>
        <a-cursor
          id="cursor"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
          event-set__mouseenter="_event: mouseenter; color: springgreen"
          event-set__mouseleave="_event: mouseleave; color: black"
          raycaster="objects: .link"></a-cursor>
      </a-entity>
    </a-scene>

    <script>
      (function () {
        const sceneEl = document.querySelector('a-scene');
        const loader = document.getElementById('loader');
        const modal = document.getElementById('headphone-modal');
        const nextBtn = document.getElementById('next-btn');
        const audioFallback = document.getElementById('audio-fallback');

        // Show modal AFTER the scene (and all <a-assets>) finish loading
        sceneEl.addEventListener('loaded', () => {
          // fade out loader then show modal
          loader.classList.add('fade-out');
          setTimeout(() => {
            loader.style.display = 'none';
            modal.style.display = 'block';
          }, 1000);
        });

        function resumeAudioContextIfSuspended() {
          try {
            if (sceneEl && sceneEl.audioListener && sceneEl.audioListener.context) {
              const ctx = sceneEl.audioListener.context;
              if (ctx.state === 'suspended') return ctx.resume();
            }
            return Promise.resolve();
          } catch (e) {
            return Promise.resolve();
          }
        }

        nextBtn.addEventListener('click', () => {
          // hide modal with fade
          modal.classList.add('fade');
          setTimeout(() => { modal.style.display = 'none'; }, 600);

          // resume audio context & attempt to play both named audios
          resumeAudioContextIfSuspended()
            .then(() => {
              const comp = sceneEl.components['scene-audio'];
              if (!comp) return Promise.reject(new Error('scene-audio component missing'));
              return comp.playAll();
            })
            .then(() => {
              // success: audios are playing in loop
              audioFallback.style.display = 'none';
            })
            .catch(err => {
              console.warn('Audio play blocked or failed:', err);
              audioFallback.style.display = 'block';
              // allow user to tap anywhere to retry once
              const retry = () => {
                resumeAudioContextIfSuspended()
                  .then(() => {
                    const comp = sceneEl.components['scene-audio'];
                    if (!comp) return;
                    return comp.playAll();
                  })
                  .then(() => {
                    audioFallback.style.display = 'none';
                    document.body.removeEventListener('click', retry);
                  })
                  .catch(() => {
                    // still blocked; keep fallback visible
                  });
              };
              document.body.addEventListener('click', retry);
            });
        });
      })();
    </script>
  </body>
</html>
